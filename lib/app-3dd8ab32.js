"use strict";angular.module("Giggity",["Giggity.filters","Giggity.services","Giggity.directives","Giggity.controllers","ui.bootstrap","ngSanitize","ngRoute","mgcrea.ngStrap"]).config(["$compileProvider",function(i){i.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|sms):/)}]).config(["$routeProvider",function(i){i.when("/gigs/:gig_id?/:action?",{templateUrl:"partials/partial2.html",controller:"Main",reloadOnSearch:!1,resolve:{MembersData:["Members",function(i){return i.promise}],GigsData:["Gigs",function(i){return i.promise}]}}),i.otherwise({redirectTo:"/gigs"})}]).run(["$route","$rootScope","$location",function(i,e,t){var n=t.search();console.log(n),n.gig_id&&(t.path("/gigs/"+n.gig_id),t.search("gig_id",null));var r=t.path;t.path=function(n,a){if(a===!1)var o=i.current,s=e.$on("$locationChangeSuccess",function(){i.current=o,s()});return r.apply(t,[n])}}]),angular.module("Giggity.controllers",[]).controller("Main",["$scope","$rootScope","$window","$route","$routeParams","Requests","$location","$filter","$position","$timeout","$modal","Members","Gigs",function(i,e,t,n,r,a,o,s,c,l,u,g,d){e.app_loaded=!1,i.Members=g,i.Gigs=d,i.gig={},i.members=[],i.membersList=[],i.currentGigIndex=0,i.gig_loading=0,i.membernamefilter="",i.memberavailablefilter="",i.currentUser=localStorage.currentUser,i.location=o,i.tab={gig_details:!0},i.mobile=!1,i.mobileView="mobile-view-nav",i.showModal=!1,i.gigLimit=15,i.page=1,i.fetchAllGigs=!1,i.$on("$routeUpdate",function(){i.setView()}),i.setTab=function(e){i.tab={},i.tab[e]=!0},i.setView=function(t){t&&(r.gig_id=null,o.path("/gigs",!1));var n=r.gig_id;!i.mobile||n?(i.mobileView="mobile-view-gig",i.fetchGig(n)):(i.mobileView="mobile-view-nav",e.app_loaded=!0)},i.changeUser=function(){i.currentUser=null,i.currentUserName=null,i.user=null,localStorage.removeItem("currentUser"),$("#current_user_input").val(),i.showModal="login"},i.saveGig=function(){return i.gig.tactical=i.gig.tactical?i.gig.tactical.id:"",i.gig.musical=i.gig.musical?i.gig.musical.id:"",a.write("saveGig",i.gig,i.gig.gig_id).then(function(e){i.Gigs.gigs[e.gig_id]=e,i.Gigs.updateGigsList(),i.setGig(e)})},i.deleteGig=function(e){return i.showModal=!1,e?a.write("deleteGig",{},e).then(function(){delete i.Gigs.gigs[i.gig.gig_id],i.Gigs.updateGigsList(),i.fetchGig()}):i.fetchGig(),!1},i.changeGig=function(e,t){var n=t?"band_details":"gig_details";i.setTab(n),r.gig_id=e,o.path("/gigs/"+e,!1),i.setView()},i.setGig=function(t){i.gig=t,i.setCurrentGigIndex(),i.gig.tactical=i.gig.tactical?i.members[i.gig.tactical]:"",i.gig.musical=i.gig.musical?i.members[i.gig.musical]:"",i.membernamefilter="",i.memberavailablefilter="",i.gig_loading=0,e.app_loaded=!0},i.fetchGig=function(e){return i.gig_loading=1,e&&i.Gigs.gigs[e]||(e=i.Gigs.gigsList[0].gig_id),a.fetch("fetchGig",{gig_id:e}).then(function(e){i.setGig(e)})},i.fetchGigs=function(){return i.Gigs.fetchGigs(i.currentUser,i.fetchAllGigs)},i.newGig=function(){i.gig={title:"New Gig",availability:{}},i.setTab("band_details")},i.setCurrentGigIndex=function(){if(i.gig){var e=i.gig.gig_id;$(i.Gigs.gigsList).each(function(t,n){return n.gig_id==e?(i.currentGigIndex=t,!1):void 0})}},i.getAvailability=function(e,t){var e=e?e:i.gig.gig_id,t=t?t:i.currentUser,n=i.Gigs.gigs[e];return t&&n&&n.availability&&n.availability[t]?"-1"==n.approved?"Gig Declined":n.availability[t].available:""},i.editUserAttrib=function(i){$("#"+i).addClass("edit"),$("#"+i+"_input").focus()},i.editAvailable=function(e){i.setTab("availability"),i.memberavailablefilter=e},i.setAvailability=function(e,t){e=e||i.currentUser;var n={member_id:e};return t?n=i.Gigs.gigs[t].availability[e]:(t=i.gig.gig_id,n=i.gig.availability[e]),n.action="setAvailability",a.write("setAvailability",n,t).then(function(n){i.Gigs.gigs[t].availability[e]=n,t==i.gig.gig_id&&(i.gig.availability[e]=i.Gigs.gigs[t].availability[e]),i.Gigs.updateGigsList()})},i.currentUser||i.changeUser(),i.$watch("fetchAllGigs",function(e,t){e!=t&&i.fetchGigs()}),i.$watch("Members.members",function(){i.members=g.members,i.membersList=g.membersList,i.members&&(i.currentUserName=i.members[i.currentUser]?i.members[i.currentUser].name:"",i.fetchGigs().then(function(){i.Gigs.gigsList.length&&(r.action&&r.gig_id&&i.currentUser?(i.Gigs.gigs[r.gig_id].availability[i.currentUser].available=r.action,i.setAvailability(i.currentUser,r.gig_id).then(function(){i.setView()})):i.setView())}))})}]);var app=angular.module("Giggity.directives",[]);app.directive("memberComments",[function(){return{restrict:"A",link:function(i,e,t){function n(t){if(t){var n=i.membersList,a="";$(n).each(function(e,n){if(t[n.id]&&t[n.id][r]){var o=n.name,s=i.gig.availability[n.id][r];a+="<strong>"+o+"</strong>:&nbsp;&nbsp;<span>"+s+"</span><br/>"}}),e.html(a)}}var r=t.type?t.type:"concerns";i.$watch("gig.availability[currentUser]",function(){n(i.gig.availability)},!0),n(i.gig.availability)}}}]),app.directive("fadeIn",function(){return{restrict:"A",link:function(i,e,t){i.$watch(t.fadeIn,function(i){i?$(e).fadeIn():$(e).hide()})}}}),app.directive("gigDetails",[function(){return{restrict:"A",link:function(i,e){function t(i){if(i){var t="";$(i.split("\n\n")).each(function(i,e){var n=e.split(":");n[0]=n[0].replace(/_/g," ").toLowerCase(),n[1]||(n[1]="&nbsp;"),t+='<dt style="text-transform:capitalize">'+n[0]+"</dt><dd class='clearfix'>"+n[1]+"</dd>"}),e.html(t)}}i.$watch("gig.details",function(i){t(i)}),t(i.gig.details)}}}]),app.directive("eatClick",function(){return function(i,e){$(e).click(function(i){return i.stopPropagation(),!1})}}),app.directive("feedbackButton",["$rootScope",function(i){return{restrict:"A",scope:{status:"@"},link:function(e,t,n){e.rootScope=i,t.bind("click",function(){e.$apply(function(){e.rootScope.remoteAction="pending",n.$set("disabled",!0),$(t).find(".glyphicon").hide(),t.prepend("<span class='processing-spinner glyphicon glyphicon-refresh glyphicon-spin'></span>")})}),e.$watch("rootScope.remoteAction",function(){e.rootScope.remoteAction||(n.$set("disabled",null),$(t).find(".processing-spinner").remove(),$(t).find(".glyphicon").show())})}}}]),app.directive("gigStatus",[function(){return{restrict:"A",link:function(i,e,t){function n(i){var t="glyphicon glyphicon-thumbs-up",n="text-success",r="Approved";-1==i?(t="glyphicon glyphicon-thumbs-down",n="text-error",r="Declined"):0==i&&(t="glyphicon glyphicon-question-sign",n="text-warning",r="Undecided"),e.html("<span class='"+n+"'><i class='"+t+"'></i> "+r+"</span>")}i.$watch("gig.approved",function(i){n(i)}),n(t.gigStatus)}}}]),app.directive("addclassonhover",function(){return{link:function(i,e,t){var n=t.addclassonhover;$(e).mouseenter(function(){$("."+n).removeClass(n),e.addClass(n)}),$(e).mouseleave(function(i){"SELECT"!=i.target.nodeName&&e.removeClass(n)})}}}),app.directive("editToggle",["$compile",function(i){return{scope:!0,link:function(e,t){e.editing=!1,e.showEdit=function(){e.editing=!0,t.addClass("edit"),$(t).find("textarea").focus()},t.find("span").after(i("<span ng-hide='editing' class='btn btn-default btn-xs' ng-click='showEdit()'><i class='glyphicon glyphicon-edit'></i> Edit<span>")(e)),t.find("textarea").on("blur",function(){e.$apply(function(){t.removeClass("edit"),e.editing=!1})})}}}]),app.directive("loadingFeedback",["$parse",function(i){return{restrict:"A",link:function(e,t,n){e.update=function(){t.parent().append("<span class='label label-primary feedback' type='button'><i class='glyphicon glyphicon-refresh glyphicon glyphicon-spin'></i> Saving...</button>");var r=i(n.loadingFeedback);r(e).then(function(){$(t).nextAll(".feedback").remove()})},t.on("change",e.update)}}}]),app.directive("resize",["$window",function(i){return{link:function(e){function t(){e.mobile=i.innerWidth<768}angular.element(i).bind("resize",function(){e.$broadcast("windowResize"),e.$apply(function(){t()})}),t()}}}]),app.directive("modal",["$rootScope","Gigs",function(i){return{restrict:"A",templateUrl:"modal.html",link:function(e){e.setUser=function(){e.user&&e.user.id?(e.currentUser=e.user.id,localStorage.currentUser=e.user.id,e.currentUserName=e.members[e.currentUser].name,$("#login_error").hide(),$("#login_form").removeClass("has-error"),e.showModal=!1,e.fetchGigs()):($("#login_form").addClass("has-error"),$("#login_error").show())},$("#modal").on("hidden.bs.modal",function(){e.$apply(function(){e.showModal=!1})}),e.$watch("showModal",function(e){0==e?($("#modal").modal("hide"),i.remoteAction=!1):($("#modal").modal("show"),$("#modal").on("shown.bs.modal",function(){$("#current_user_input").focus()}))})}}}]),app.directive("datePicker",function(){return{restrict:"E",template:'<div class="input-group date-picker"><input class="form-control" ng-model="model" use-native="true" data-model-date-format="yyyy-MM-dd" data-date-format="MM/dd/yyyy" data-date-type="string" data-autoclose="1" bs-datepicker type="text"><span ng-click="focus()" class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></span></div>',scope:{model:"="},link:function(i,e){i.focus=function(){$(e).find("input").focus()}}}}),app.directive("timePicker",function(){return{restrict:"E",template:'<div class="input-group time-picker col-xs-5"><input class="form-control" size="8" ng-model="model" use-native="true" data-time-type="string" data-autoclose="1" bs-timepicker data-model-time-format="hh:mm a" data-time-format="h:mm a" data-length="1" data-minute-step="1" data-arrow-behavior="picker" type="text"><span ng-click="focus()" class="input-group-addon"><i class="glyphicon glyphicon-time"></i></span></div>',scope:{model:"="},link:function(i,e){i.focus=function(){$(e).find("input").focus()}}}});var app=angular.module("Giggity.filters",[]);app.filter("toArray",function(){return function(i){return i instanceof Object?$.map(i,function(i,e){return Object.defineProperty(i,"$key",{__proto__:null,value:e})}):i}}),app.filter("nlBr",function(){return function(i){return i?i.replace(/\n\n/g,"<br/>"):void 0}}),app.filter("length",function(){return function(i){return i.length}}),app.filter("memberProperty",function(){return function(i,e){var t=e[0],n=e[1]?e[1]:", ",r=[];return $(i).each(function(i,e){r.push(e[t])}),r.join(n)}}),app.filter("available",function(){return function(i){return i?i="Yes"==i?"Available":"No"==i?"Unavailable":i:void 0}}),app.filter("userUnknownCount",function(){return function(i,e){var t=0;return e&&$(i).each(function(i,n){-1!=n.approved&&"Unknown"==n.availability[e].available&&t++}),t}}),app.filter("URIencode",function(){return window.encodeURIComponent}),app.filter("availableFilter",function(){return function(i,e){var t=[],n=e[0];if(e[1]&&e[1].availability){var r=e[1].availability;return $(i).each(function(i,e){r[e.id]&&("Coming"!=n||"Yes"!=r[e.id].available&&"Maybe"!=r[e.id].available?(r[e.id].available==n||""==n)&&t.push(e):t.push(e))}),t}return i}}),app.filter("commentFilter",function(){return function(i,e){var t="comments",n=[];return e&&e.availability?($(i).each(function(i,r){e.availability[r.id]&&e.availability[r.id][t]&&n.push(r)}),n):i}}),app.filter("concernFilter",function(){return function(i,e){var t="concerns",n=[];return e&&e.availability?($(i).each(function(i,r){e.availability[r.id]&&e.availability[r.id][t]&&n.push(r)}),n):i}}),app.filter("member",function(){return function(i){return i?i.name:void 0}}),app.filter("time",function(){return function(i){if(!i)return null;if(i.indexOf("M")>=0)return i;var e=i.split(":"),t=e[0],n=e[1],r="AM";return t>12?(t-=12,r="PM"):12==t?r="PM":0==t&&(t=12),t+":"+n+" "+r}}),app.filter("slice",function(){return function(i,e,t){return i instanceof Array?i.slice(e).slice(0,t):i}});var app=angular.module("Giggity.services",[]);app.service("Members",["Requests","$filter",function(i,e){var t=this;return t.members=null,t.membersList=null,t.promise=i.fetch("fetchMembers").then(function(i){t.members=i,t.membersList=e("orderBy")(e("toArray")(t.members),"name")}),t.getMembers=function(){return members},t}]),app.service("Gigs",["Requests","$filter",function(i,e){var t=this;return t.gigs=null,t.gigsList=null,t.updateGigsList=function(){t.gigsList=e("orderBy")(e("toArray")(t.gigs),"date")},t.fetchGigs=function(e,n){return i.fetch("fetchGigs",{fetchAllGigs:n,user_id:e}).then(function(i){t.gigs=i,t.updateGigsList()})},t}]),app.service("Requests",["$http","$rootScope",function(i,e){var t=this,n=function(i){e.remoteAction=!1;var i=i.data,t="An error occurred";if(1!==i.statusCode){var n;return"undefined"==typeof i.statusCode?(n="<pre>"+i+"</pre>",t="An unknown error occurred"):n=i.statusString,$("#status").html(t+": "+n).removeClass().addClass("alert alert-danger").show(),void(e.app_loaded=!0)}return $("#status").hide(),i.data};t.fetch=function(t,r){return e.remoteAction=t,r=r||{},r.action=t,i.get("backend/requests.php",{params:r,timeout:6e5}).then(n)},t.write=function(t,r,a){return e.remoteAction=t,i.post("backend/requests.php",{action:t,gig_id:a,data:r},{timeout:6e5}).then(n)}}]);